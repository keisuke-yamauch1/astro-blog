---
import { getCollection } from 'astro:content';
import DiaryPost from '../../../../layouts/DiaryPost.astro';
import { filterPublishedDiaries } from '../../../../utils/posts';
import { getDateParts, matchesDateParts } from '../../../../utils/date';

export async function getStaticPaths() {
  const entries = await getCollection('diary');
  const publishedEntries = filterPublishedDiaries(entries);

  return publishedEntries.map((entry) => {
    const { year, month, day } = getDateParts(entry.data.date);

    return {
      params: { year, month, day },
      props: { entry },
    };
  });
}

const { year, month, day } = Astro.params;
const { entry } = Astro.props;

// Validate that the entry matches the date
if (!matchesDateParts(entry.data.date, { year, month, day })) {
  return Astro.redirect('/404');
}

const { Content } = await entry.render();
---

<DiaryPost entry={entry}>
  <Content />
</DiaryPost>