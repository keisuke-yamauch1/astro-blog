---
import { getCollection } from 'astro:content';
import DiaryPost from '../../../../../../layouts/DiaryPost.astro';
import PreviewBanner from '../../../../../../components/PreviewBanner.astro';

export const prerender = false;

// 下書きを含むすべての日記を取得（明示的にドラフトも含める）
const allDiaries = await getCollection('diary', () => true);

const { year, month, day } = Astro.params;

// デバッグ: 検索対象の日付に近いエントリーのみ表示
const searchDate = `${year}-${month}-${day}`;
const relevantDiaries = allDiaries.filter(d => {
  const id = d.id.toLowerCase();
  return id.includes(year) || id.includes(searchDate) || d.data.draft === true;
});

console.log('Total diaries:', allDiaries.length);
console.log('Relevant diaries (including all drafts):', relevantDiaries.map(d => ({
  id: d.id,
  date: d.data.date,
  dateType: typeof d.data.date,
  draft: d.data.draft,
  dateString: d.data.date?.toString()
})));
console.log('URL params:', { year, month, day });

// URLパラメータと一致する日記を検索（堅牢な日付マッチング）
const entry = allDiaries.find((diary) => {
  const diaryDate = diary.data.date;

  // Dateオブジェクトの場合
  if (diaryDate instanceof Date) {
    const diaryYear = diaryDate.getFullYear().toString();
    const diaryMonth = (diaryDate.getMonth() + 1).toString().padStart(2, '0');
    const diaryDay = diaryDate.getDate().toString().padStart(2, '0');

    const matches = diaryYear === year && diaryMonth === month && diaryDay === day;
    if (matches) console.log('Matched entry (Date):', diary.id);
    return matches;
  }

  // 文字列の場合
  if (typeof diaryDate === 'string') {
    const matches = diaryDate === `${year}-${month}-${day}`;
    if (matches) console.log('Matched entry (string):', diary.id);
    return matches;
  }

  return false;
});

console.log('Found entry:', entry?.id || 'NOT FOUND');

// エントリーが見つからない場合はデバッグ情報を表示
if (!entry) {
  const debugInfo = {
    searchDate: `${year}-${month}-${day}`,
    allDiariesCount: allDiaries.length,
    allDiaries: allDiaries.map(d => ({
      id: d.id,
      date: d.data.date,
      dateType: typeof d.data.date,
      draft: d.data.draft
    }))
  };

  return new Response(
    `<!DOCTYPE html>
    <html lang="ja">
    <head>
      <meta charset="UTF-8">
      <title>Entry not found - Debug Info</title>
      <style>
        body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
        pre { background: #252526; padding: 15px; border-radius: 5px; overflow-x: auto; }
        h1 { color: #e06c75; }
      </style>
    </head>
    <body>
      <h1>Entry not found</h1>
      <p>検索日付: ${year}-${month}-${day}</p>
      <pre>${JSON.stringify(debugInfo, null, 2)}</pre>
    </body>
    </html>`,
    { status: 404, headers: { 'content-type': 'text/html; charset=utf-8' } }
  );
}

const { Content } = await entry.render();

// 編集URLを構築（ファイル名をクエリパラメータに渡す）
const editUrl = `/admin?edit=${entry.id}`;
const dateString = `${year}-${month}-${day}`;
---

<!-- 認証チェック -->
<script is:inline>
  const token = localStorage.getItem('admin_token');
  if (!token) {
    window.location.href = '/admin/login';
  }
</script>

<PreviewBanner editUrl={editUrl} date={dateString} filename={entry.id} />

<DiaryPost entry={entry} isPreview={true}>
  <Content />
</DiaryPost>
