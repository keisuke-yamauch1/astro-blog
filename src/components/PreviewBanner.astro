---
interface Props {
  editUrl: string;  // 編集画面に戻るURL
  date: string;     // 公開用の日付（YYYY-MM-DD形式）
  filename: string; // 下書きファイル名
}

const { editUrl, date, filename } = Astro.props;
---

<div class="fixed top-0 left-0 right-0 z-50 bg-orange-500 dark:bg-orange-600 text-white py-3 px-4 shadow-lg">
  <div class="max-w-3xl mx-auto flex items-center justify-between flex-wrap gap-4">
    <div class="flex items-center gap-2">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
      </svg>
      <span class="font-bold">プレビューモード</span>
      <span class="text-sm opacity-90 hidden sm:inline">この記事はまだ公開されていません</span>
    </div>

    <div class="flex gap-3">
      <a
        href={editUrl}
        class="px-4 py-2 bg-white text-orange-600 rounded font-medium hover:bg-gray-100 transition"
      >
        編集に戻る
      </a>
      <button
        id="publish-from-preview"
        data-date={date}
        class="px-4 py-2 bg-green-600 text-white rounded font-medium hover:bg-green-700 transition"
      >
        公開する
      </button>
    </div>
  </div>
</div>

<!-- プレビューバナー分のスペーサー -->
<div class="h-16"></div>

<script is:inline define:vars={{ filename, date }}>
  const publishBtn = document.getElementById('publish-from-preview');

  publishBtn?.addEventListener('click', async () => {
    const token = localStorage.getItem('admin_token');
    if (!token) {
      alert('認証トークンが見つかりません。ログインしてください。');
      window.location.href = '/admin/login';
      return;
    }

    if (!confirm('この日記を公開しますか？\n（gitにコミット＆プッシュされます）')) {
      return;
    }

    try {
      publishBtn.textContent = '公開中...';
      publishBtn.disabled = true;

      const response = await fetch('/admin/api/publish-draft', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          filename: filename,
          date: date
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('✓ 公開成功！');
        const [year, month, day] = date.split('-');
        window.location.href = `/diary/${year}/${month}/${day}`;
      } else {
        alert(`エラー: ${result.error}`);
        publishBtn.textContent = '公開する';
        publishBtn.disabled = false;
      }
    } catch (error) {
      alert(`エラー: ${error.message}`);
      publishBtn.textContent = '公開する';
      publishBtn.disabled = false;
    }
  });
</script>
